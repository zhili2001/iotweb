import{_ as x,u as C,r as I,l as S,c as i,b as s,F as k,d as f,k as U,m as p,o as c,w as y,g as N,e as T,t as _,v as w,n as A}from"./index-BUOmST_B.js";const B={class:"iot-container"},E={class:"device-list"},F={class:"device-header"},K={key:0,class:"original-name"},L=["onUpdate:modelValue"],M={class:"key-list"},P={class:"key-info"},R={class:"key-name"},$={class:"original-name"},q={class:"key-value"},J={class:"key-controls"},O={class:"key-alias-row"},j=["onUpdate:modelValue"],z={class:"key-type-row"},G=["onUpdate:modelValue"],H=["onClick"],Q=["onClick"],W={__name:"IoTPlatform",setup(X){const n=C(),v=U(),h=I({}),r=()=>{(!n.isAuthenticated||n.expiresAt<Date.now())&&(alert("登录已过期，请重新登录"),n.logout(),v.push("/login"))},d=async()=>{try{r();const{data:t}=await p.get("/api/iot/devices",{params:{userId:n.userId}});for(const a in t){const e=t[a];e.new_mac_alias=e.mac_alias||"",e.keys=e.keys||[],e.msg=e.msg||"{}",e.keys.forEach(l=>{l.new_key_alias=l.key_alias||"",l.type=l.device_type||"1"})}h.value=t}catch(t){u(t,"获取设备失败")}},g=(t,a)=>{try{return JSON.parse(t).msg[a]||"无数据"}catch{return"数据解析失败"}},b=async(t,a)=>{try{r(),await p.post("/api/iot/set_keyvalue",{mac_address:a,mac_alias:t.new_mac_alias,keys:t.keys.map(e=>({mac_key:e.mac_key,key_alias:e.new_key_alias||e.mac_key,device_type:e.type}))}),alert("配置已保存"),await d()}catch(e){u(e,"保存失败")}},V=async()=>{try{r(),await p.post("/api/iot/save_keys",{userId:n.userId}),await d(),alert("设备信息已刷新")}catch(t){u(t,"刷新设备信息失败")}},D=async t=>{try{if(r(),!confirm("确定要移除该网关吗？"))return;await p.delete("/api/iot/delete-device",{data:{mac_address:t}}),alert("网关已移除"),await d()}catch(a){u(a,"移除网关失败")}},u=(t,a)=>{var e;console.error(a,t),((e=t.response)==null?void 0:e.status)===401?(alert("登录已过期，请重新登录"),n.logout(),v.push("/login")):alert(a)};return S(()=>{r(),d()}),(t,a)=>(c(),i("div",B,[a[3]||(a[3]=s("h2",null,"设备管理",-1)),s("button",{onClick:V,class:"refresh-btn"},"刷新设备信息"),s("div",E,[(c(!0),i(k,null,f(h.value,(e,l)=>(c(),i("div",{key:l,class:"device-card"},[s("div",F,[s("h3",null,[N(" 网关: "+_(e.mac_alias||l)+" ",1),e.mac_alias?(c(),i("span",K,"("+_(l)+")",1)):T("",!0)]),y(s("input",{"onUpdate:modelValue":o=>e.new_mac_alias=o,placeholder:"输入网关别名",class:"alias-input"},null,8,L),[[w,e.new_mac_alias]])]),s("div",M,[(c(!0),i(k,null,f(e.keys,o=>(c(),i("div",{key:o.mac_key,class:"key-item"},[s("div",P,[s("span",R,_(o.key_alias||o.mac_key),1),s("span",$,"("+_(o.mac_key)+")",1),s("span",q,_(g(e.msg,o.mac_key)),1)]),s("div",J,[s("div",O,[a[0]||(a[0]=s("label",{class:"key-label"},"设备名:",-1)),y(s("input",{"onUpdate:modelValue":m=>o.new_key_alias=m,placeholder:"输入设备别名",class:"key-input"},null,8,j),[[w,o.new_key_alias]])]),s("div",z,[a[2]||(a[2]=s("label",{class:"key-label"},"设备类型:",-1)),y(s("select",{"onUpdate:modelValue":m=>o.type=m,class:"key-select"},a[1]||(a[1]=[s("option",{value:"1"},"传感器",-1),s("option",{value:"2"},"控制器",-1),s("option",{value:"3"},"自动化开关",-1)]),8,G),[[A,o.type]])])])]))),128))]),s("button",{onClick:o=>b(e,l),class:"save-btn"},"保存配置",8,H),s("button",{onClick:o=>D(l),class:"remove-btn"},"移除网关",8,Q)]))),128))])]))}},Z=x(W,[["__scopeId","data-v-1053fda4"]]);export{Z as default};
